# ConcordiumWalletCrypto

[Swift package](https://developer.apple.com/documentation/xcode/swift-packages) providing bindings for Swift
of Concordium specific cryptographic functions that are written in Rust.

The project is a core component of the [Concordium Swift SDK](https://github.com/Concordium/concordium-swift-sdk.git).
It has its own repository because of limitations in SwiftPM
that prevent us from publishing everything in a single complete package.
In brief, Swift packages must be downloaded straight from git,
not a registry to which we can publish a complete build.
This repository thus serves the dual purpose of hosting the Rust sources
while simultaneously hosting the Swift package.

To avoid storing large binaries in git, a workflow compiles the bindings into an
[XCFramework](https://developer.apple.com/documentation/xcode/distributing-binary-frameworks-as-swift-packages)
and uploads it to GitHub as a release in this repository.

The Swift package specification refers to such a release, not the local Rust sources.
This means that the Swift sources (i.e. generated bridge code) and package spec made up by this repo
and its Rust sources aren't in sync between releases:
The Swift files always refer to the latest published release, even during development of the next version.

## Prior usage

This repository/package was previously used to host the binaries built from a previous incarnation of the Rust library
which was built and hosted elsewhere.
See commit 6b6af29816b0f966598b170d62334e2faf00062b for details.

That package is still available from tag
[`0.24.0-0`](https://github.com/Concordium/concordium-wallet-crypto-swift/releases/tag/0.24.0-0) and
[in use](https://github.com/Concordium/concordium-reference-wallet-ios/blob/main/ConcordiumWallet.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved)
by the iOS reference wallet, but it's not expected to receive updates in the future.

## Versioning

The available versions of the package are represented by the commit tags of this repository.
The version is defined by the Rust/Cargo project.

## Build

Supported Rust version: 1.72

*Prerequisites*

The repository uses git submodules. Make sure that all submodules are checked out correctly using

```shell
git submodule update --init
```

This must be done after the initial clone as well as every time you switch branch.

Ensure that the correct Rust toolchain has been installed with all the expected targets:

```shell
make setup
```

*Build*

Run

```shell
make framework
```

This script will compile the sources into a framework `./generated/ConcordiumWalletCryptoUniffi.xcframework`
that supports the following platforms:

- macOS: x86_64 (`x86_64-apple-darwin`) and ARM (`aarch64-apple-darwin`) as a universal binary
- iOS: ARM (`aarch64-apple-ios`)
- iOS simulator: x86_64 (`x86_64-apple-ios`) and ARM (`aarch64-apple-ios-sim`) as a universal binary.

The makefile is structured such that the targets can be easily combined to build other combinations of architectures.
The resulting framework is ready be integrated directly into an XCode project or a SwiftPM project as a binary target
in the project's `Package.swift` file.
In our [`Package.swift`](./Package.swift), the framework is referring to a GitHub release as explained above.

## Development

### Swift package

This repository is a Rust project with an embedded SwiftPM package for using it from Swift.
The Swift bridge in `./Sources` is generated by UniFFI and must not be edited manually.

The package spec file `Package.swift` is only edited as part of publishing a release.
This is also the only time that the generated changes in `./Sources` are committed.

The environment variable `CONCORDIUM_WALLET_CRYPTO_FRAMEWORK_PATH`
may be used to select a locally compiled framework instead of the released one.
This allows one to use an unreleased version during development of the SDK.
Note that even when this is used from downstream projects,
the provided path is evaluated relative to the root of this project.

For convenience, if `CONCORDIUM_WALLET_CRYPTO_PATH` is set
(indicating that we're using a development version of this library)
then `CONCORDIUM_WALLET_CRYPTO_FRAMEWORK_PATH` will default to `./generated/ConcordiumWalletCryptoUniffi.xcframework`.
Provide the empty string to that variable to disable this behavior.

### Rust

The Rust source files are expected to be formatted according to `cargo fmt`.

The version in `Cargo.toml` is not updated during regular development.
Explanation of changes are added to `CHANGELOG.md` under the "unreleased" section.
The version and changelog are updated as part of the release process,
which is explained in detail below.

## Release new version

The steps for building and releasing a new version `<version>` of the library are as follows:

1. Bump the version to `<version>` in `Cargo.toml` and insert the changelog header in a separate "release" PR.
2. Push a tag named `build/<version>-<build-version>` for the commit,
   where `<build-version>` is bumped (starting from 0) for each attempt at building `<version>`.
   This is necessary because GitHub requires releases to be tagged and the following workflow uploads a release.
3. Run the [workflow](./.github/workflows/publish-framework.yml) for publishing a new version of the binary framework.
   Use the tag you just created as "branch" to run from and input `<version>` (i.e. without the counter for "Version").
4. Run `make swift-bindings` locally to regenerate the Swift bridge sources.
5. Update `Package.swift` with the updated `url` and `checksum` of the binary framework.
   The workflow prints the checksum as the last step of its execution.
6. Commit the changes to `Sources/ConcordiumWalletCrypto/crypto.swift` and `Package.swift`
   (no other files should have changes)
   and push an annotated tag named by the version for the new commit:
   ```shell
   git tag -a <version>
   ```
   Give the tag a message describing what changed in the new version.

The entire process should be done as a single PR which,
in order to preserve the tags, gets merged without squashing.
